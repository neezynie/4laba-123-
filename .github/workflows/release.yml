name: Deploy on Release

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: github-pages
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Create version
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "üöÄ Deploying: $VERSION"
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –≤–µ—Ä—Å–∏–∏
          mkdir -p "versions/$VERSION"
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
          cp -r en/ ru/ index.html "versions/$VERSION/"
          
          # –°–æ–∑–¥–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –≤–µ—Ä—Å–∏–∏
          cat > "versions/$VERSION/index.html" << EOF
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>–í–µ—Ä—Å–∏—è $VERSION - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞</title>
              <style>
                  body { 
                      font-family: 'Segoe UI', Arial, sans-serif; 
                      max-width: 900px; 
                      margin: 0 auto; 
                      padding: 40px 20px; 
                      line-height: 1.6;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      min-height: 100vh;
                  }
                  .container {
                      background: white;
                      border-radius: 15px;
                      padding: 40px;
                      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                  }
                  nav { 
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                      padding: 20px; 
                      border-radius: 10px; 
                      margin-bottom: 30px;
                      text-align: center;
                  }
                  nav a { 
                      margin: 0 20px; 
                      text-decoration: none; 
                      color: white; 
                      font-weight: bold;
                      font-size: 18px;
                      padding: 10px 20px;
                      border-radius: 25px;
                      transition: all 0.3s;
                  }
                  nav a:hover { 
                      background: rgba(255,255,255,0.2);
                      transform: translateY(-2px);
                  }
                  .version-info { 
                      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); 
                      color: white;
                      padding: 20px; 
                      border-radius: 10px; 
                      margin: 20px 0;
                      text-align: center;
                      font-size: 18px;
                  }
                  .btn-group {
                      text-align: center;
                      margin: 30px 0;
                  }
                  .btn {
                      display: inline-block;
                      padding: 15px 30px;
                      margin: 10px;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: white;
                      text-decoration: none;
                      border-radius: 25px;
                      font-weight: bold;
                      transition: all 0.3s;
                      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                  }
                  .btn:hover {
                      transform: translateY(-3px);
                      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
                  }
                  h1 {
                      text-align: center;
                      color: #333;
                      margin-bottom: 10px;
                  }
                  .subtitle {
                      text-align: center;
                      color: #666;
                      margin-bottom: 30px;
                      font-size: 18px;
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ4</h1>
                  <div class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ web –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
                  
                  <div class="version-info">
                      <strong>–í–µ—Ä—Å–∏—è:</strong> $VERSION | 
                      <strong>–î–∞—Ç–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è:</strong> $(date +"%d.%m.%Y %H:%M")
                  </div>

                  <nav>
                      <a href="ru/">–†—É—Å—Å–∫–∞—è –≤–µ—Ä—Å–∏—è</a>
                      <a href="en/">English Version</a>
                  </nav>

                  <div class="btn-group">
                      <a href="ru/" class="btn">üá∑üá∫ –†—É—Å—Å–∫–∞—è –≤–µ—Ä—Å–∏—è</a>
                      <a href="en/" class="btn">üá∫üá∏ English Version</a>
                      <a href="../../" class="btn">üìö –í—Å–µ –≤–µ—Ä—Å–∏–∏</a>
                  </div>

                  <footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; text-align: center; color: #666;">
                      <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ —á–µ—Ä–µ–∑ GitHub Actions</p>
                  </footer>
              </div>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Files in versions/$VERSION/:"
          ls -la "versions/$VERSION/"
          
      - name: Update versions list
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          echo "üìù Updating versions.json"
          
          if [ ! -f versions.json ]; then
            echo '[]' > versions.json
          fi
          
          node -e "
          const fs = require('fs');
          let versions = [];
          try {
            versions = JSON.parse(fs.readFileSync('versions.json'));
          } catch(e) {}
          
          if (!versions.find(v => v.name === '$VERSION')) {
            versions.unshift({
              name: '$VERSION',
              url: 'versions/$VERSION',
              date: new Date().toISOString(),
              description: 'Automated release'
            });
            console.log('‚úÖ Added version: $VERSION');
          }
          
          fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
          console.log('Total versions:', versions.length);
          "
          
      - name: Upload and deploy
        uses: actions/upload-pages-artifact@v3
        with: 
          path: .
          
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
