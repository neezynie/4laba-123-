name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  release:
    types: [published]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Create version structure
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
            echo "ðŸš€ Deploying RELEASE version: $VERSION"
          else
            SHORT_SHA="${GITHUB_SHA:0:7}"
            DATE=$(date +'%Y%m%d')
            VERSION="dev-${DATE}-${SHORT_SHA}"
            echo "ðŸš€ Deploying DEV version: $VERSION"
          fi
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð²ÐµÑ€ÑÐ¸Ð¸
          mkdir -p "versions/$VERSION"
          
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ„Ð°Ð¹Ð»Ñ‹
          cp -r en/ ru/ index.html "versions/$VERSION/"
          
          echo "âœ… Created version: $VERSION"
          echo "ðŸ“ Files in versions/$VERSION/:"
          ls -la "versions/$VERSION/"
          
      - name: Update versions list
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ
          if [[ "${{ github.event_name }}" == "release" ]]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            SHORT_SHA="${GITHUB_SHA:0:7}"
            DATE=$(date +'%Y%m%d')
            VERSION="dev-${DATE}-${SHORT_SHA}"
          fi
          
          echo "ðŸ“ Updating versions.json for version: $VERSION"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½Ñ‹Ð¹ versions.json ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
          if [ ! -f versions.json ]; then
            echo '[]' > versions.json
            echo "ðŸ“„ Created new versions.json"
          fi
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ versions.json Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Node.js
          node -e "
          const fs = require('fs');
          let versions = [];
          try {
            versions = JSON.parse(fs.readFileSync('versions.json'));
            console.log('ðŸ“– Loaded existing versions.json');
          } catch(e) {
            console.log('ðŸ“„ Creating new versions array');
            versions = [];
          }
          
          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÑƒÐ¶Ðµ Ñ‚Ð°ÐºÐ°Ñ Ð²ÐµÑ€ÑÐ¸Ñ
          const existingVersion = versions.find(v => v.name === '$VERSION');
          if (!existingVersion) {
            versions.unshift({
              name: '$VERSION',
              url: 'versions/$VERSION',
              date: new Date().toISOString(),
              description: '${{ github.event_name }} deployment'
            });
            console.log('âœ… Added new version: $VERSION');
          } else {
            console.log('â„¹ï¸ Version already exists: $VERSION');
          }
          
          // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾
          fs.writeFileSync('versions.json', JSON.stringify(versions, null, 2));
          console.log('ðŸ“Š Total versions:', versions.length);
          "
          
      - name: Show final structure
        run: |
          echo "ðŸ“ Final structure:"
          find . -name "*.html" | head -10
          echo "ðŸ“Š Total HTML files: $(find . -name "*.html" | wc -l)"
          echo "ðŸ“‹ Versions available: $(ls -1 versions/ 2>/dev/null | wc -l || echo 0)"
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
